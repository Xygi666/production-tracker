const CONFIG={VERSION:'3.2.9',STORAGE_KEYS:{PRODUCTS:'pt_products_v3',ENTRIES:'pt_entries_v3',SHIFTS:'pt_shifts_v3',SALARY:'pt_salary_v3',THEME:'pt_theme_v3',LOG:'pt_log_v3',PRESETS:'pt_presets_v3'},DEFAULT_CURRENCY:'₽',DATE_FORMAT:'ru-RU',MAX_LOG:1000};
const Safe={g:(k,f=null)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):f}catch(e){console.warn('Safe.g',k,e);return f}},s:(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v));return true}catch(e){console.warn('Safe.s',k,e);return false}},gr:(k,f='')=>{try{return localStorage.getItem(k)??f}catch(e){console.warn('Safe.gr',k,e);return f}},sr:(k,v)=>{try{localStorage.setItem(k,v);return true}catch(e){console.warn('Safe.sr',k,e);return false}}};
class App{constructor(){this.data={products:Safe.g(CONFIG.STORAGE_KEYS.PRODUCTS,[]),entries:Safe.g(CONFIG.STORAGE_KEYS.ENTRIES,[]),shifts:Safe.g(CONFIG.STORAGE_KEYS.SHIFTS,[]),salary:Safe.g(CONFIG.STORAGE_KEYS.SALARY,{baseSalary:50000,taxRate:13,advanceAmount:0,workSchedule:'off',hoursPerShift:12,scheduleStartDate:'2025-09-01'}),log:Safe.g(CONFIG.STORAGE_KEYS.LOG,[]),presets:Safe.g(CONFIG.STORAGE_KEYS.PRESETS,[1,5,10,25,50]),theme:Safe.gr(CONFIG.STORAGE_KEYS.THEME,'classic')};if(!this.data.products?.length)this.data.products=[{id:1,name:'Изделие А',price:100,archived:false,created:new Date().toISOString(),favorite:false}];this.data.products.forEach(p=>{if(p.favorite===undefined)p.favorite=false});this.q=s=>document.querySelector(s);this.qa=s=>document.querySelectorAll(s);this.cacheDOM();this.bindEvents();this.applyTheme(this.data.theme);if(!Array.from(this.screens).some(s=>s.classList.contains('screen--active')))this.switchScreen('records');this.renderPresets();this.applyManualDefaultHours();this.updateProductSuggestions();this.renderRecords();this.renderStatistics();this.renderHistory();console.log('[App] init ok')}
cacheDOM(){this.monthSumHeader=this.q('#monthSumHeader');this.finalAmountHeader=this.q('#finalAmountHeader');this.settingsBtn=this.q('#settingsBtn');this.exportJsonBtn=this.q('#exportJsonBtn');this.reloadBtn=this.q('#reloadBtn');this.navTabs=this.qa('.nav__tab');this.screens=this.qa('.screen');this.productSearch=this.q('#productSearch');this.clearSearchBtn=this.q('#clearSearchBtn');this.productSuggestions=this.q('#productSuggestions');this.selectedProductId=null;this.quantityInput=this.q('#quantityInput');this.decreaseBtn=this.q('#decreaseBtn');this.increaseBtn=this.q('#increaseBtn');this.presetsContainer=this.q('#presetsContainer');this.sumAmount=this.q('#sumAmount');this.addRecordBtn=this.q('#addRecordBtn');this.recordsList=this.q('#recordsList');this.exportCsvBtn=this.q('#exportCsvBtn');this.manualShiftHours=this.q('#manualShiftHours');this.addManualShiftBtn=this.q('#addManualShiftBtn');this.statsGrid=this.q('#statsGrid');this.filterDate=this.q('#filterDate');this.filterAction=this.q('#filterAction');this.historyList=this.q('#historyList');this.exportHistoryBtn=this.q('#exportHistoryBtn');this.settingsModal=this.q('#settingsModal');this.closeSettingsBtn=this.q('#closeSettingsBtn');this.saveSettingsBtn=this.q('#saveSettingsBtn');this.cancelSettingsBtn=this.q('#cancelSettingsBtn');this.settingsTabs=this.qa('.settings-tab');this.settingsPanels=this.qa('.settings-panel');this.baseSalary=this.q('#baseSalary');this.taxRate=this.q('#taxRate');this.advanceAmount=this.q('#advanceAmount');this.workSchedule=this.q('#workSchedule');this.hoursPerShift=this.q('#hoursPerShift');this.scheduleStartDate=this.q('#scheduleStartDate');this.addProductBtn=this.q('#addProductBtn');this.importProductsBtn=this.q('#importProductsBtn');this.importProductsFile=this.q('#importProductsFile');this.productsList=this.q('#productsList');this.themeSelect=this.q('#themeSelect');this.presetsInput=this.q('#presetsInput');this.productModal=this.q('#productModal');this.productModalTitle=this.q('#productModalTitle');this.productNameInput=this.q('#productNameInput');this.productPriceInput=this.q('#productPriceInput');this.closeProductBtn=this.q('#closeProductBtn');this.saveProductBtn=this.q('#saveProductBtn');this.cancelProductBtn=this.q('#cancelProductBtn');this.emailBackupBtn=this.q('#emailBackupBtn');['settingsBtn','exportJsonBtn','reloadBtn','productSearch','quantityInput','addRecordBtn','recordsList','statsGrid','historyList','settingsModal','themeSelect'].forEach(k=>{if(!this[k])console.warn('[DOM missing]',k)})}
bindEvents(){this.navTabs.forEach(t=>t.addEventListener('click',e=>this.switchScreen(e.currentTarget.dataset.tab)));this.settingsBtn&&this.settingsBtn.addEventListener('click',()=>this.openSettings());this.exportJsonBtn&&this.exportJsonBtn.addEventListener('click',()=>this.exportJson());this.reloadBtn&&this.reloadBtn.addEventListener('click',()=>location.reload());this.productSearch&&this.productSearch.addEventListener('input',()=>this.updateProductSuggestions());this.productSearch&&this.productSearch.addEventListener('focus',()=>this.updateProductSuggestions());this.clearSearchBtn&&this.clearSearchBtn.addEventListener('click',()=>this.clearSearch());document.addEventListener('click',e=>{if(this.productSuggestions&&!this.productSuggestions.contains(e.target)&&e.target!==this.productSearch&&e.target!==this.clearSearchBtn)this.hideSuggestions()});if(this.quantityInput){this.quantityInput.setAttribute('step','1');this.quantityInput.setAttribute('min','1');this.quantityInput.addEventListener('input',()=>{const v=Math.max(1,Math.floor(parseFloat(this.quantityInput.value)||1));this.quantityInput.value=v;this.calculateSum()})}this.decreaseBtn&&this.decreaseBtn.addEventListener('click',()=>{const c=Math.max(1,Math.floor(parseFloat(this.quantityInput.value)||1));this.quantityInput.value=Math.max(1,c-1);this.calculateSum()});this.increaseBtn&&this.increaseBtn.addEventListener('click',()=>{const c=Math.max(1,Math.floor(parseFloat(this.quantityInput.value)||1));this.quantityInput.value=c+1;this.calculateSum()});this.addRecordBtn&&this.addRecordBtn.addEventListener('click',()=>this.addRecord());this.exportCsvBtn&&this.exportCsvBtn.addEventListener('click',()=>this.exportCsv());this.addManualShiftBtn&&this.addManualShiftBtn.addEventListener('click',()=>this.addManualShift());this.filterDate&&this.filterDate.addEventListener('change',()=>this.renderHistory());this.filterAction&&this.filterAction.addEventListener('change',()=>this.renderHistory());this.exportHistoryBtn&&this.exportHistoryBtn.addEventListener('click',()=>this.exportHistory());this.closeSettingsBtn&&this.closeSettingsBtn.addEventListener('click',()=>this.closeSettings());this.cancelSettingsBtn&&this.cancelSettingsBtn.addEventListener('click',()=>this.closeSettings());this.saveSettingsBtn&&this.saveSettingsBtn.addEventListener('click',()=>this.saveSettings());this.settingsTabs.forEach(t=>t.addEventListener('click',e=>this.switchSettingsPanel(e.currentTarget.dataset.tab)));this.settingsModal&&this.settingsModal.addEventListener('click',e=>{if(e.target===this.settingsModal||e.target.classList.contains('modal__backdrop'))this.closeSettings()});this.themeSelect&&this.themeSelect.addEventListener('change',()=>{this.data.theme=this.themeSelect.value;this.applyTheme(this.data.theme);Safe.sr(CONFIG.STORAGE_KEYS.THEME,this.data.theme)});this.addProductBtn&&this.addProductBtn.addEventListener('click',()=>this.openProductModal());this.importProductsBtn&&this.importProductsBtn.addEventListener('click',()=>this.importProductsFile.click());this.importProductsFile&&this.importProductsFile.addEventListener('change',e=>this.importProducts(e.target.files[0]));this.closeProductBtn&&this.closeProductBtn.addEventListener('click',()=>this.closeProductModal());this.cancelProductBtn&&this.cancelProductBtn.addEventListener('click',()=>this.closeProductModal());this.saveProductBtn&&this.saveProductBtn.addEventListener('click',()=>this.saveProduct());this.productModal&&this.productModal.addEventListener('click',e=>{if(e.target===this.productModal||e.target.classList.contains('modal__backdrop'))this.closeProductModal()});this.emailBackupBtn&&this.emailBackupBtn.addEventListener('click',()=>this.shareBackup('email'))}
switchScreen(name){this.navTabs.forEach(t=>t.classList.toggle('nav__tab--active',t.dataset.tab===name));this.screens.forEach(s=>{const active=s.dataset.screen===name;s.classList.toggle('screen--active',active);s.style.display=active?'block':'none'});if(name==='records'){this.updateProductSuggestions();this.applyManualDefaultHours();this.renderRecords()}if(name==='statistics')this.renderStatistics();if(name==='history')this.renderHistory()}
switchSettingsPanel(name){this.settingsTabs.forEach(t=>t.classList.toggle('settings-tab--active',t.dataset.tab===name));this.settingsPanels.forEach(p=>p.classList.toggle('settings-panel--active',p.dataset.panel===name))}
applyTheme(theme){document.body.setAttribute('data-theme',theme)}
clearSearch(){if(!this.productSearch)return;this.productSearch.value='';this.selectedProductId=null;this.updateProductSuggestions();this.calculateSum();this.updateClearButton()}
updateClearButton(){if(!this.clearSearchBtn||!this.productSearch)return;this.productSearch.value.trim()?this.clearSearchBtn.classList.remove('hidden'):this.clearSearchBtn.classList.add('hidden')}
updateProductSuggestions(){if(!this.productSuggestions)return;this.updateClearButton();const q=(this.productSearch?.value||'').trim().toLowerCase();const all=(this.data.products||[]).filter(p=>!p.archived);all.sort((a,b)=>(a.favorite===b.favorite)?0:(a.favorite?-1:1));const list=q?all.filter(p=>p.name.toLowerCase().includes(q)):all;this.renderSuggestions(list.slice(0,30))}
renderSuggestions(items){if(!this.productSuggestions)return;if(!items.length){this.productSuggestions.innerHTML='';this.productSuggestions.classList.add('hidden');this.selectedProductId=null;this.calculateSum();return}this.productSuggestions.classList.remove('hidden');this.productSuggestions.innerHTML='';items.forEach(p=>{const row=document.createElement('div');row.className='suggestion-item';row.innerHTML=`<span class="suggestion-star ${p.favorite?'suggestion-star--favorite':''}" data-id="${p.id}">★</span><span class="suggestion-text">${p.name} — ${p.price}${CONFIG.DEFAULT_CURRENCY}</span>`;row.querySelector('.suggestion-text').addEventListener('click',()=>{if(this.productSearch)this.productSearch.value=p.name;this.selectedProductId=p.id;this.hideSuggestions();this.calculateSum();this.updateClearButton()});row.querySelector('.suggestion-star').addEventListener('click',e=>{e.stopPropagation();this.toggleFavorite(p.id)});this.productSuggestions.appendChild(row)});const exact=items.find(p=>p.name.toLowerCase()===(this.productSearch?.value||'').trim().toLowerCase());this.selectedProductId=exact?exact.id:null}
hideSuggestions(){this.productSuggestions&&this.productSuggestions.classList.add('hidden')}
toggleFavorite(productId){const p=(this.data.products||[]).find(x=>x.id===productId);if(!p)return;p.favorite=!p.favorite;this.save();this.updateProductSuggestions();this.renderProductsList();this.log('edit_product',p,p.favorite?'Добавлен в избранное':'Убран из избранного')}
renderPresets(){if(!this.presetsContainer)return;this.presetsContainer.innerHTML='';(this.data.presets||[]).forEach(v=>{const b=document.createElement('button');b.className='preset-btn';b.textContent=v;b.addEventListener('click',()=>{const base=Math.max(0,Math.floor(parseFloat(this.quantityInput?.value)||0));if(this.quantityInput)this.quantityInput.value=base===0?Number(v):base+Number(v);this.calculateSum()});this.presetsContainer.appendChild(b)})}
applyManualDefaultHours(){if(this.manualShiftHours)this.manualShiftHours.value=this.data.salary?.hoursPerShift??8}
currentProduct(){if(this.selectedProductId)return(this.data.products||[]).find(p=>p.id===this.selectedProductId)||null;const q=(this.productSearch?.value||'').trim().toLowerCase();if(!q)return null;return(this.data.products||[]).find(p=>!p.archived&&p.name.toLowerCase()===q)||null}
calculateSum(){const p=this.currentProduct();const qty=Math.max(1,Math.floor(parseFloat(this.quantityInput?.value)||1));if(this.sumAmount)this.sumAmount.textContent=p?`${(qty*p.price).toFixed(2)} ${CONFIG.DEFAULT_CURRENCY}`:`0 ${CONFIG.DEFAULT_CURRENCY}`}
addRecord(){const p=this.currentProduct();const qty=Math.max(1,Math.floor(parseFloat(this.quantityInput?.value)||1));if(!p)return alert('Выберите продукт (начните ввод и выберите из списка)');const rec={id:Date.now(),productId:p.id,quantity:qty,price:p.price,sum:qty*p.price,date:new Date().toISOString()};(this.data.entries=this.data.entries||[]).push(rec);this.log('add_record',rec,'Добавлена запись');this.save();if(this.quantityInput)this.quantityInput.value='';this.calculateSum();this.renderRecords();this.renderStatistics()}
renderRecords(){if(!this.recordsList)return;const now=new Date();const ym=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;const list=(this.data.entries||[]).filter(e=>{const d=new Date(e.date);return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`===ym}).sort((a,b)=>new Date(b.date)-new Date(a.date));const income=list.reduce((s,r)=>s+r.sum,0);if(this.monthSumHeader)this.monthSumHeader.textContent=`${income.toFixed(2)} ${CONFIG.DEFAULT_CURRENCY}`;this.recordsList.innerHTML=list.length?'':'<div class="record-item"><div class="record-info"><div class="record-title">Записей за текущий месяц нет</div></div></div>';list.forEach(r=>{const p=(this.data.products||[]).find(x=>x.id===r.productId);const name=p?p.name:'Неизвестный продукт';const d=new Date(r.date);const row=document.createElement('div');row.className='record-item';row.innerHTML=`<div class="record-info"><div class="record-title">${this.esc(name)}</div><div class="record-details">${r.quantity} × ${r.price}${CONFIG.DEFAULT_CURRENCY} = ${r.sum.toFixed(2)}${CONFIG.DEFAULT_CURRENCY}</div><div class="record-details">${d.toLocaleDateString(CONFIG.DATE_FORMAT)} ${d.toLocaleTimeString(CONFIG.DATE_FORMAT,{hour:'2-digit',minute:'2-digit'})}</div></div><div class="record-actions"><button class="btn btn--sm btn--danger">🗑️</button></div>`;row.querySelector('button').addEventListener('click',()=>this.deleteRecord(r.id));this.recordsList.appendChild(row)})}
deleteRecord(id){if(!confirm('Удалить запись?'))return;const i=(this.data.entries||[]).findIndex(r=>r.id===id);if(i>=0){const old=this.data.entries[i];this.data.entries.splice(i,1);this.log('delete_record',old,'Удалена запись');this.save();this.renderRecords();this.renderStatistics()}}
addManualShift(){const h=parseFloat(this.manualShiftHours?.value);if(!h||h<=0)return alert('Введите часы (>0)');const sh={id:Date.now(),date:new Date().toISOString().slice(0,10),hours:h,type:'work',comment:'',auto:false};(this.data.shifts=this.data.shifts||[]).push(sh);this.log('add_shift',sh,`Добавлена смена: ${h} ч`);this.save();this.applyManualDefaultHours();this.renderStatistics()}
renderStatistics(){if(!this.statsGrid)return;const now=new Date();const y=now.getFullYear();const m=now.getMonth()+1;const month=(this.data.entries||[]).filter(e=>{const d=new Date(e.date);return d.getFullYear()===y&&(d.getMonth()+1)===m});const income=month.reduce((s,r)=>s+r.sum,0);const manual=(this.data.shifts||[]).filter(s=>{const d=new Date(s.date);return d.getFullYear()===y&&(d.getMonth()+1)===m&&!s.auto}).reduce((s,a)=>s+(parseFloat(a.hours)||0),0);let auto=0;if(this.data.salary.workSchedule!=='off'&&typeof WorkScheduleManager==='function'){const ws=new WorkScheduleManager();ws.updateSettings(this.data.salary);auto=ws.calculateAutoHours(y,m)}const hours=manual+auto;const base=+this.data.salary.baseSalary||0;const tax=(+this.data.salary.taxRate||0)/100;const adv=+this.data.salary.advanceAmount||0;const hourly=hours>0?(base+income)/hours:0;const taxAmount=(base+income)*tax;const finalAmount=(base+income)-taxAmount-adv;const cards=[{label:'Доход (выручка)',value:`${income.toFixed(2)} ${CONFIG.DEFAULT_CURRENCY}`,type:'income'},{label:'Оклад',value:`${base.toFixed(2)} ${CONFIG.DEFAULT_CURRENCY}`,type:'neutral'},{label:'Часы отработано',value:`${hours.toFixed(1)} ч`,type:'neutral'},{label:'Почасовая ставка',value:`${hourly.toFixed(2)} ${CONFIG.DEFAULT_CURRENCY}/ч`,type:'neutral'},{label:'Налог',value:`${taxAmount.toFixed(2)} ${CONFIG.DEFAULT_CURRENCY}`,type:'expense'},{label:'На руки (итог)',value:`${finalAmount.toFixed(2)} ${CONFIG.DEFAULT_CURRENCY}`,type:finalAmount>=0?'income':'expense'}];this.statsGrid.innerHTML='';cards.forEach(c=>{const el=document.createElement('div');el.className=`stat-card stat-card--${c.type}`;el.innerHTML=`<div class="stat-value">${c.value}</div><div class="stat-label">${c.label}</div>`;this.statsGrid.appendChild(el)});if(this.monthSumHeader)this.monthSumHeader.textContent=`${income.toFixed(2)} ${CONFIG.DEFAULT_CURRENCY}`;if(this.finalAmountHeader)this.finalAmountHeader.textContent=`${finalAmount.toFixed(2)} ${CONFIG.DEFAULT_CURRENCY}`}
openSettings(){if(!this.settingsModal)return;const s=this.data.salary||{};if(this.baseSalary)this.baseSalary.value=s.baseSalary??0;if(this.taxRate)this.taxRate.value=s.taxRate??13;if(this.advanceAmount)this.advanceAmount.value=s.advanceAmount??0;if(this.workSchedule)this.workSchedule.value=s.workSchedule??'off';if(this.hoursPerShift)this.hoursPerShift.value=s.hoursPerShift??12;if(this.scheduleStartDate)this.scheduleStartDate.value=s.scheduleStartDate??'';if(this.themeSelect)this.themeSelect.value=this.data.theme||'classic';if(this.presetsInput)this.presetsInput.value=(this.data.presets||[]).join(',');this.renderProductsList();this.settingsModal.classList.add('modal--active')}
closeSettings(){this.settingsModal?.classList.remove('modal--active')}
saveSettings(){this.data.salary={baseSalary:parseFloat(this.baseSalary?.value)||0,taxRate:parseFloat(this.taxRate?.value)||0,advanceAmount:parseFloat(this.advanceAmount?.value)||0,workSchedule:this.workSchedule?.value||'off',hoursPerShift:parseFloat(this.hoursPerShift?.value)||12,scheduleStartDate:this.scheduleStartDate?.value||new Date().toISOString().slice(0,10)};const theme=this.themeSelect?.value||this.data.theme;if(theme!==this.data.theme){this.data.theme=theme;this.applyTheme(theme);Safe.sr(CONFIG.STORAGE_KEYS.THEME,theme)}const presets=(this.presetsInput?.value||'').split(',').map(x=>parseFloat(x.trim())).filter(x=>!isNaN(x)&&x>0);this.data.presets=presets.length?presets:[1,5,10,25,50];this.log('settings',this.data.salary,'Изменены настройки');this.save();this.closeSettings();this.renderPresets();this.applyManualDefaultHours();this.renderStatistics()}
openProductModal(productId=null){this.editingProductId=productId;if(productId){const p=(this.data.products||[]).find(x=>x.id===productId);if(p){this.productModalTitle.textContent='Изменить продукт';this.productNameInput.value=p.name;this.productPriceInput.value=p.price}}else{this.productModalTitle.textContent='Добавить продукт';this.productNameInput.value='';this.productPriceInput.value=''}this.productModal.classList.add('modal--active');setTimeout(()=>this.productNameInput?.focus(),100)}
closeProductModal(){this.productModal?.classList.remove('modal--active');this.editingProductId=null}
saveProduct(){const name=this.productNameInput?.value?.trim();const price=parseFloat(this.productPriceInput?.value);if(!name)return alert('Введите название продукта');if(isNaN(price)||price<=0)return alert('Введите корректную цену');if(this.editingProductId){const p=(this.data.products||[]).find(x=>x.id===this.editingProductId);if(p){p.name=name;p.price=price;this.log('edit_product',p,'Изменён продукт')}}else{const p={id:Date.now(),name,price,archived:false,created:new Date().toISOString(),favorite:false};(this.data.products=this.data.products||[]).push(p);this.log('add_product',p,'Добавлен продукт')}this.save();this.closeProductModal();this.renderProductsList();this.updateProductSuggestions()}
renderProductsList(){if(!this.productsList)return;this.productsList.innerHTML='';(this.data.products||[]).forEach(p=>{const row=document.createElement('div');row.className='record-item';const star=p.favorite?'⭐':'☆';row.innerHTML=`<div class="record-info"><div class="record-title">${star} ${this.esc(p.name)}</div><div class="record-details">${p.price}${CONFIG.DEFAULT_CURRENCY}</div></div><div class="record-actions"><button class="btn btn--sm btn--outline" data-a="fav">${p.favorite?'Убрать':'Избранное'}</button><button class="btn btn--sm btn--outline" data-a="edit">Изменить</button><button class="btn btn--sm btn--outline" data-a="toggle">${p.archived?'Восстановить':'Архив'}</button><button class="btn btn--sm btn--danger" data-a="del">Удалить</button></div>`;row.querySelector('[data-a="fav"]').addEventListener('click',()=>this.toggleFavorite(p.id));row.querySelector('[data-a="edit"]').addEventListener('click',()=>this.openProductModal(p.id));row.querySelector('[data-a="toggle"]').addEventListener('click',()=>this.toggleProduct(p.id));row.querySelector('[data-a="del"]').addEventListener('click',()=>this.deleteProduct(p.id));this.productsList.appendChild(row)})}
toggleProduct(id){const p=(this.data.products||[]).find(x=>x.id===id);if(!p)return;p.archived=!p.archived;this.log('edit_product',p,p.archived?'Архивирован':'Восстановлен');this.save();this.renderProductsList();this.updateProductSuggestions()}
deleteProduct(id){if((this.data.entries||[]).some(e=>e.productId===id))return alert('Нельзя удалить продукт с записями. Переведите его в архив.');if(!confirm('Удалить продукт?'))return;const i=(this.data.products||[]).findIndex(p=>p.id===id);if(i>=0){const old=this.data.products[i];this.data.products.splice(i,1);this.log('delete_product',old,'Удалён продукт');this.save();this.renderProductsList();this.updateProductSuggestions()}}
shareBackup(type){const data={version:CONFIG.VERSION,timestamp:new Date().toISOString(),data:this.data};const content=JSON.stringify(data,null,2);const subject=encodeURIComponent('Backup Production Tracker');const body=encodeURIComponent('Бэкап данных от '+new Date().toLocaleDateString()+':\n\n'+content.substring(0,1000)+'...');window.open(`mailto:?subject=${subject}&body=${body}`,'_self')}
renderHistory(){if(!this.historyList)return;const df=this.filterDate?.value;const af=this.filterAction?.value;let list=[...(this.data.log||[])];if(df)list=list.filter(e=>new Date(e.timestamp).toISOString().slice(0,10)===df);if(af)list=list.filter(e=>e.action===af);list.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));this.historyList.innerHTML=list.length?'':'<div class="record-item"><div class="record-info"><div class="record-title">История
